# 多端一套技术栈
本文是记录寻找多端统一技术方案选型的一个思考过程。

根据笔者以往的经验，最终决定某项技术方案在团队的落地，应该包括技术选型以及项目和技术管理；需要多方位的思考，不止考虑团队技术情况，还有时间、成本等方面的考量。做好充分准备有理有据，定好目标，还需要进行定期复盘。

这个过程很重要，在公司内部有人提出质疑和疑惑的时候，有充分的资料来告诉对方，这是慎重的一个决定，经过详细的调查和研究。

## 需求目的
在设备多端，以及应用承载方式越来越多，各大平台技术孤立的时代，需要寻找一套可靠，优秀的技术解决方案，来提升我们开发实现产品的效率，降低实现的技术成本，以及达到最好的产品效果。

## 技术分析

> 候选技术

+ 原生开发
+ 阿里 Weex
+ Facebook RN
+ Google Flutter
+ 京东 Taro
+ 美团 MpVue
+ DCloud uni-app
+ 腾讯 Wepy
+ 去哪儿 Nanachi
+ 滴滴 Mpx
+ 网易考拉 Megalo
+ 微信支付 Omi-mp
+ 滴滴 Chameleon

1. 全包型
这类框架最大的特点就是从底层的渲染引擎、布局引擎，到中层的 DSL，再到上层的框架全部由自己开发，代表框架是 Qt 和 Flutter。这类框架优点非常明显：性能（的上限）高；各平台渲染结果一致。缺点也非常明显：需要完全重新学习 DSL（QML/Dart），以及难以适配中国特色的端：小程序。
这类框架是最原始也是最纯正的的多端开发框架，由于底层到上层每个环节都掌握在自己手里，也能最大可能地去保证开发和跨端体验一致。但它们的框架研发成本巨大，渲染引擎、布局引擎、DSL、上层框架每个部分都需要大量人力开发维护。

2. Web 技术型
这类框架把 Web 技术（JavaScript，CSS）带到移动开发中，自研布局引擎处理 CSS，使用 JavaScript 写业务逻辑，使用流行的前端框架作为 DSL，各端分别使用各自的原生组件渲染。代表框架是 React Native 和 Weex，这样做的优点有：

开发迅速
复用前端生态
易于学习上手，不管前端后端移动端，多多少少都会一点 JS、CSS

缺点有：

交互复杂时难以写出高性能的代码，这类框架的设计就必然导致 JS 和 Native  之间需要通信，类似于手势操作这样频繁地触发通信就很可能使得 UI 无法在 16ms 内及时绘制。React Native 有一些声明式的组件可以避免这个问题，但声明式的写法很难满足复杂交互的需求。

由于没有渲染引擎，使用各端的原生组件渲染，相同代码渲染的一致性没有第一种高。

3. JavaScript 编译型
这类框架就是我们这篇文章的主角们：Taro、WePY、uni-app、mpvue、chameleon，它们的原理也都大同小异：先以 JavaScript 作为基础选定一个 DSL 框架，以这个 DSL 框架为标准在各端分别编译为不同的代码，各端分别有一个运行时框架或兼容组件库保证代码正确运行。

这类框架最大优点和创造的最大原因就是小程序，因为第一第二种框架其实除了可以跨系统平台之外，也都能编译运行在浏览器中。(Qt 有 Qt for WebAssembly, Flutter 有 Hummingbird，React Native 有 react-native-web, Weex 原生支持)
另外一个优点是在移动端一般会编译到 React Native/Weex，所以它们也都拥有 Web 技术型框架的优点。这看起来很美好，但实际上 React Native/Weex 的缺点编译型框架也无法避免。除此之外，编译型框架的抽象也不是免费的：当 bug 出现时，问题的根源可能出在运行时、编译时、组件库以及三者依赖的库等等各个方面。

但这并不意味着这类为了小程序而设计的多端框架就都不堪大用。首先现在各巨头超级 App 的小程序百花齐放，框架会为了抹平小程序做了许多工作，这些工作在大部分情况下是不需要开发者关心的。其次是许多业务类型并不需要复杂的逻辑和交互，没那么容易触发到框架底层依赖的bug。

所以的业务适合选择编译型框架时，在笔者看来首先要考虑的就是选择 DSL 的起点。因为有多端需求业务通常都希望能快速开发，一个能够快速适应团队开发节奏的 DSL 就至关重要。不管是 React 还是 Vue（或者类 Vue）都有它们的优缺点，需要根据团队技术栈和偏好进行选择。

### 项目因素
+ 项目规模，我们的应用需要支撑上（百）？万用户的使用
+ 重要程度，小程序是公司目前最主要的入口，急需从其它端增加产品和突破点
+ 时间要求，互联网时代，迭代速度也是非常大的一个要点和门槛，技术实现时间上肯定是越快越好
+ 需要支持SEO？
+ 希望是实现沉浸式的体验？
+ 希望能达到比现在更好的性能体验
+ 希望能在更多的端实现统一的产品体验

### 团队因素
+ 项目目前技术栈主要是 Vue + VueX && Node + (Next)?
+ 成员技术栈 Vue React Flutter React-Native？
+ 成员对现有技术的满意度以及对新技术的期望

### 技术因素
+ 能否满足"功能"需求
+ 能否满足"性能"需求
+ 易用性
+ 可维护性
+ 可扩展性
+ 技术成熟度
+ 社区活跃度
+ 开发者或支持团队活跃度
+ 是否存在license问题
+ 学习曲线如何

### 技术选型
综合，以上的分析，那么采取第3种js编译类型的解决方案，是目前成本较低，速度较快的；那么我们先来看看市面上已经有的技术，如下：

> 初步分析

|框架|技术栈|	案例|	微信小程序|	支付宝小程序|	百度小程序|	头条小程序|	H5|	App|
| --- | -----:   | :----: | :----: | :----: | :----: | :----: | :----: | :----: |
|Taro|	React|	丰富|	⭕|	⭕|	⭕|	⭕|	⭕|	⭕|
|wepy|	Vue	|丰富	|⭕	|❌|	❌|❌	|❌	|❌|
|mpvue|	Vue	|丰富	|⭕|	❌|	❌|	❌|	⭕|️	❌|
|uni-app|Vue|丰富	|⭕|	⭕|	⭕️|	⭕|	⭕️|	⭕|
|Megalo|Vue	|少	|⭕	|⭕️|⭕️|	❌|❌|❌|
|OKAM|	Vue	|少|	⭕	|⭕	|⭕	|⭕| ❌| ❌|
|Mpx|	Vue	|少|	⭕	|❌	|❌	|❌|	❌| ❌|
|Chameleon| Vue | 少| ⭕ |❌	|❌	|❌|	❌| ❌|
|weex| Vue

+ 采用Vue技术栈，可考虑自研webapck编译，结合目前的小程序的技术；从vue打包成小程序，weex解决App问题
+ 采用Ract的Taro，RN跨端组件库解决App问题
+ 除了uni-app其它框架暂不支持App不宜考虑

> 初步选择

|公司 | 框架|
| :---: | :---: |
|京东 |Taro|
|DCloud | uni-app|
|美团 |MpVue|
|腾讯 |wepy|
|滴滴 |Chameleon|

### 开发对比

|流行度/方案	|Taro	|uni-app|	MpVue	|wepy	|Chameleon|
| --- | :-----:   | :----: | :----: | :----: | :----: |
|GitHub Star|	16588|	3734|	|	|	|
|GitHub issue/PR|	382|	54|	|	|	|
|NPM/CNPM 下载量|	4413|		|||		
|案例	|丰富	|丰富 |1万+|	|||		
|开发者人数	|~5000	|			|||
|自建开发者社区	|√ 有	|√ 有	|	||||

> 开发工具

|工具/方案	|Taro	|uni-app|MpVue|	wepy|	Chameleon|
| --- | :-----:   | :----: | :----: | :----: | :----: |
|语法规范	|React, 类原生|	Vue||||
|IDE/图形化开发工具|	× 无，有VSCode插件|	√||||	
|语法校验工具	|√ IDE支持|	√ IDE支持||||
|TypeScript |	√|	√||||
|Typing/自动补全|	√ IDE支持|	√ IDE支持||||		
|样式|	scss/less/stylus自编译构建|	scss/less/stylus||||

> 组件库/工具库/Demo

|组件库/方案|	Taro|	uni-app|	MpVue|	wepy	|Chameleon|
| --- | :----: | :----: | :----: | :----: | :----: |
|第三方组件|	丰富|	丰富||||
|第三方工具库|	丰富|	丰富||||
|Demo|	丰富|	较丰富||||
|状态管理工具|	Redux, Mobx, Dva|	Vuex||||		
|转换微信小程序工具|	√ 有|	× 无	||||		
|自研组件库|	√ 有|	√ 有||||
|自动构建|	√ 有|	自建构建系统||||

## 实践（坑）
+ 支付宝小程序  
|不支持Swipe  
|不支持授权登陆  
+ 百度小程序  
|不支持个人开发注册appid

## 结果评审
### 评审意见：

xxx
xxxx
xxxxx
做出决定
我们最终决定选择XXX技术方案

### 复盘问题：

### 解决方案：

